name: CI â€” Build & Test (No Signing)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: macos-latest
    env:
      # Prevent xcode/xcodebuild from trying to sign when building for simulator
      CODE_SIGNING_ALLOWED: "NO"
      CODE_SIGNING_REQUIRED: "NO"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Resolve Swift packages if Package.swift exists
        if: ${{ always() && (hashFiles('**/Package.swift') != '') }}
        run: swift package resolve

      - name: Show available simulators (info)
        run: xcrun simctl list devices

      - name: Build (iOS Simulator)
        run: |
          xcodebuild \
            -project LandscapeDesigner.xcodeproj \
            -scheme "LandscapeDesigner" \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -resultBundlePath build/ios-result.xcresult \
            clean build \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO

      - name: Test (iOS Simulator)
        run: |
          xcodebuild \
            -project LandscapeDesigner.xcodeproj \
            -scheme "LandscapeDesigner" \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 15' \
            -resultBundlePath build/ios-test.xcresult \
            clean test \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO

      - name: Build macOS (if applicable)
        run: |
          xcodebuild \
            -project LandscapeDesigner.xcodeproj \
            -scheme "LandscapeDesigner" \
            -destination 'platform=macOS' \
            -resultBundlePath build/macos-result.xcresult \
            clean build \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO

      - name: Upload xcresult artifacts
        uses: actions/upload-artifact@v4
        with:
          name: xcresults
          path: build/*.xcresult

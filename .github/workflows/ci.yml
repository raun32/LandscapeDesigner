name: Build & Release Landscape Designer

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build-macos-binary:
    name: Build macOS Native App
    runs-on: macos-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Show Swift version
        run: swift --version

      - name: Show Xcode version
        run: xcodebuild -version

      - name: Compile LandscapeDesigner Binary
        run: |
          echo "üî® Building Landscape Designer..."
          swiftc -target x86_64-apple-macosx10.15 \
                  EnhancedApp.swift \
                  -o LDApp \
                  -framework AppKit \
                  -framework Foundation
          echo "‚úÖ Build successful!"

      - name: Verify Binary
        run: |
          echo "üì¶ Binary verification:"
          file LDApp
          ls -lh LDApp
          echo ""
          echo "‚úÖ Binary ready for deployment"

      - name: Create App Bundle
        run: |
          echo "üì¶ Creating macOS app bundle..."
          mkdir -p LandscapeDesigner.app/Contents/{MacOS,Resources}
          
          # Copy compiled binary
          cp LDApp LandscapeDesigner.app/Contents/MacOS/LandscapeDesigner
          chmod +x LandscapeDesigner.app/Contents/MacOS/LandscapeDesigner
          
          # Create Info.plist
          cat > LandscapeDesigner.app/Contents/Info.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleDevelopmentRegion</key>
              <string>en</string>
              <key>CFBundleExecutable</key>
              <string>LandscapeDesigner</string>
              <key>CFBundleIdentifier</key>
              <string>com.raun32.landscapedesigner</string>
              <key>CFBundleInfoDictionaryVersion</key>
              <string>6.0</string>
              <key>CFBundleName</key>
              <string>Landscape Designer</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>CFBundleShortVersionString</key>
              <string>1.0.0</string>
              <key>CFBundleVersion</key>
              <string>1</string>
              <key>NSPrincipalClass</key>
              <string>NSApplication</string>
              <key>NSHumanReadableCopyright</key>
              <string>Copyright ¬© 2025 raun32. All rights reserved.</string>
          </dict>
          </plist>
          EOF
          
          echo "‚úÖ App bundle created"

      - name: Create DMG Installer
        run: |
          echo "üíø Creating DMG installer..."
          
          # Clean up any existing DMG
          rm -f LandscapeDesigner.dmg
          
          # Create DMG contents directory
          rm -rf DMG_Contents
          mkdir -p DMG_Contents
          
          # Copy app bundle
          cp -r LandscapeDesigner.app DMG_Contents/
          
          # Create Applications symlink
          ln -s /Applications DMG_Contents/Applications 2>/dev/null || true
          
          # Create the DMG with explicit parameters
          hdiutil create -volname "Landscape Designer" \
                         -srcfolder DMG_Contents \
                         -ov -format UDZO \
                         -fs HFS+ \
                         LandscapeDesigner.dmg 2>&1
          
          # Verify DMG was created
          if [ -f LandscapeDesigner.dmg ]; then
            echo "‚úÖ DMG created successfully"
            ls -lh LandscapeDesigner.dmg
            file LandscapeDesigner.dmg
          else
            echo "‚ùå DMG creation failed"
            exit 1
          fi

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LandscapeDesigner-binary
          path: LDApp
          retention-days: 30

      - name: Upload App Bundle Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LandscapeDesigner-app-bundle
          path: LandscapeDesigner.app
          retention-days: 30

      - name: Upload DMG Installer Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LandscapeDesigner-installer
          path: LandscapeDesigner.dmg
          retention-days: 30

      - name: Generate Build Report
        run: |
          echo "=========================================="
          echo "üìä BUILD REPORT"
          echo "=========================================="
          echo ""
          echo "‚úÖ Binary compiled: LandscapeDesigner"
          echo "‚úÖ App bundle created: LandscapeDesigner.app"
          echo "‚úÖ DMG installer created: LandscapeDesigner.dmg"
          echo ""
          echo "üì¶ Artifacts available for download:"
          echo "  1. LandscapeDesigner-binary"
          echo "  2. LandscapeDesigner-app-bundle"
          echo "  3. LandscapeDesigner-installer"
          echo ""
          echo "üöÄ Installation instructions:"
          echo "  1. Go to Actions ‚Üí Latest workflow ‚Üí Artifacts"
          echo "  2. Download 'LandscapeDesigner-installer' (DMG)"
          echo "  3. Extract and open LandscapeDesigner.dmg"
          echo "  4. Drag app to /Applications"
          echo "  5. Double-click to launch"
          echo ""
          echo "=========================================="
